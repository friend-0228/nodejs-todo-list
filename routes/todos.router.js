// express ê°€ì ¸ì˜¤ê¸°
import express from "express";
import Joi from "joi";
// todoSchema ì‚¬ìš©ì„ ìœ„í•´ ê°€ì ¸ì˜¤ê¸°
import Todo from "../schemas/todo.schema.js";

// router ìƒì„± ê°€ëŠ¥
const router = express.Router();

//----------------------------------------------------------------------------
/** * Joi * **/
// ğŸ‘‰ **í•  ì¼ ìƒì„± API ìœ íš¨ì„± ê²€ì‚¬ ìš”êµ¬ì‚¬í•­**
// 1. `value` ë°ì´í„°ëŠ” **í•„ìˆ˜ì ìœ¼ë¡œ ì¡´ì¬**í•´ì•¼í•œë‹¤.
// 2. `value` ë°ì´í„°ëŠ” **ë¬¸ìì—´ íƒ€ì…**ì´ì–´ì•¼í•œë‹¤.
// 3. `value` ë°ì´í„°ëŠ” **ìµœì†Œ 1ê¸€ì ì´ìƒ**ì´ì–´ì•¼í•œë‹¤.
// 4. `value` ë°ì´í„°ëŠ” **ìµœëŒ€ 50ê¸€ì ì´í•˜**ì—¬ì•¼í•œë‹¤.
// 5. ìœ íš¨ì„± ê²€ì‚¬ì— ì‹¤íŒ¨í–ˆì„ ë•Œ, ì—ëŸ¬ê°€ ë°œìƒí•´ì•¼í•œë‹¤.
const createdTodoSchema = Joi.object({
    value: Joi.string().min(1).max(50).required(),
});

//----------------------------------------------------------------------------
/** * í• ì¼ ë“±ë¡ API * **/
// APIë¥¼ êµ¬í˜„í•  ë•ŒëŠ” í•´ë‹¹ ë¼ìš°í„°ë¡œ êµ¬í˜„ ì‹œì‘.
router.post("/todos", async (req, res, next) => {
    try {
        // 1. í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ë°›ì•„ì˜¨ value ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
        // const { value } = req.body;

        const validation = await createdTodoSchema.validateAsync(req.body);

        const { value } = validation;

        // 1-2. ë§Œì•½ í´ë¼ì´ì–¸íŠ¸ê°€ value ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ì§€ ì•Šì•˜ì„ ë•Œ, í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ì „ë‹¬í•œë‹¤.
        if (!value) {
            return res.status(400).json({
                errorMessage: "í•´ì•¼í•  ì¼(value) ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
            });
        }

        // 2. í•´ë‹¹í•˜ëŠ” ë§ˆì§€ë§‰ order ë°ì´í„°ë¥¼ ì¡°íšŒí•œë‹¤.
        /* 		Todo ë¼ê³  í•˜ëŠ” ê²ƒì„ ê°€ì ¸ì™€ì•¼í•œë‹¤. ì´ê±´ ê·¸ ì „ì— todo.schema.js ì—ì„œ êµ¬í˜„í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
			export default mongoose.model('Todo', todoSchema);
			-> todoSchemaë¥¼ mongooseì˜ modelì— ë§Œë“¤ì–´ì„œ ì™¸ë¶€ì— ì „ë‹¬í•˜ê³  ìˆëŠ” ê²ƒ.
    		===> Todoë€ todoSchemaì— ìˆëŠ” mongoose.model ì´ë‹¤. */
        // findOne = 1ê°œì˜ ë°ì´í„°ë§Œ ì¡°íšŒí•œë‹¤.
        // sort : ì •ë ¬í•œë‹¤. -> ì–´ë–¤ ì»¬ëŸ¼ì„? order ë¼ëŠ” ì»¬ëŸ¼ì„! ì–´ë–¤ ë°ì´í„°ë² ì´ìŠ¤? No! ì»¬ë ‰ì…˜! Todoë¼ëŠ” ì»¬ë ‰ì…˜ì—ì„œ ì°¾ëŠ”ë‹¤.
        // order ì•ì— ë§ˆì´ë„ˆìŠ¤(-)ë¥¼ ë¶™ì—¬ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•  ìˆ˜ ìˆê²Œ ë§Œë“ ë‹¤.
        // 	exec() ë©”ì„œë“œ
        //	mongooseì—ì„œ exec()ëŠ” ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ê¸° ìœ„í•´ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³ , ì´ ê²°ê³¼ë¡œ Promiseë¥¼ ë°˜í™˜.
        //	===> mongoose ì¡°íšŒí•  ë•ŒëŠ” .exec() ë©”ì„œë“œë¥¼ ë¬´ì¡°ê±´ ë¶™ì´ëŠ”ê±¸ë¡œ!
        const todoMaxOrder = await Todo.findOne().sort("-order").exec();

        // 3. ë§Œì•½ ì¡´ì¬í•œë‹¤ë©´ í˜„ì¬ í•´ì•¼ í•  ì¼ì„ +1 í•˜ê³ , order ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•Šë‹¤ë©´, 1ë¡œ í• ë‹¹í•œë‹¤.
        const order = todoMaxOrder ? todoMaxOrder.order + 1 : 1;

        // 4. í•´ì•¼í•  ì¼ ë“±ë¡
        const todo = new Todo({ value, order }); // todo ë¼ê³  í•˜ëŠ” ê²ƒì„ ì‹¤ì œ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë§Œë“¤ì—ˆë‹¤.
        await todo.save(); // ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•œë‹¤.

        // 5. í•´ì•¼í•  ì¼ì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°˜í™˜í•œë‹¤.
        return res.status(201).json({ todo: todo });
    } catch (error) {
        // Router ë‹¤ìŒì— ìˆëŠ” ì—ëŸ¬ ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‹¤í–‰í•œë‹¤.
        next(error);
    }
});

//----------------------------------------------------------------------------
/** * í•´ì•„í•  ì¼ ëª©ë¡ ì¡°íšŒ API * **/
router.get("/todos", async (req, res, next) => {
    // nextëŠ” ì•ˆ ë„£ì–´ì¤˜ë„ ë˜ì§€ë§Œ ë‚˜ì¤‘ì— ë¦¬íŒ©í† ë§í•  ë•Œë¥¼ ìœ„í•´ ë„£ì–´ë‘” ê²ƒ.
    // 1. í•´ì•¼í•  ì¼ ëª©ë¡ ì¡°íšŒë¥¼ ì§„í–‰í•œë‹¤.
    //	await ì„ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ë°ì´í„° ì¡°íšŒí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦° ë‹¤ìŒì— ì½”ë“œë¥¼ ìˆ˜í–‰í•œë‹¤.
    const todos = await Todo.find().sort("-order").exec();

    // 2. í•´ì•¼í•  ì¼ ëª©ë¡ ì¡°íšŒ ê²°ê³¼ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°˜í™˜í•œë‹¤.
    return res.status(200).json({ todos });
});

//----------------------------------------------------------------------------
/** * í•´ì•„í•  ì¼ ìˆœì„œ ë³€ê²½ API * **/
// ëª©ë¡ì¤‘ì— ì–´ë–¤ ê²ƒì„ ìˆ˜ì •í•´ì•¼í• ì§€ ì•Œê¸° ìœ„í•´ì„œ todoId ì‚¬ìš©
// ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•  ê²ƒì´ê¸° ë•Œë¬¸ì— ë¹„ë™ê¸°ì ì¸ ì²˜ë¦¬ë¥¼ ë™ê¸°ì ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— async ì‚¬ìš©.
router.patch("/todos/:todoId", async (req, res, next) => {
    //	=> ê°’ ê°€ì ¸ì˜¤ê¸°
    // ì–´ë–¤ í• ì¼ì„ ë³€ê²½í•´ì•¼ í• ì§€ ì•Œì•„ì•¼ í•œë‹¤.
    const { todoId } = req.params;
    // ìˆœì„œ ë³€ê²½ : ì‹¤ì œë¡œ í´ë¼ì´ì–¸íŠ¸ê°€ í•´ë‹¹í•˜ëŠ” ê°’ì„ ëª‡ ë²ˆ ìˆœì„œë¡œ ë³€ê²½í• ê±´ì§€ì— ëŒ€í•œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    const { order, done, value } = req.body;

    // ì‹¤ì œ ë¡œì§
    // í˜„ì¬ ë‚˜ì˜ orderê°€ ë¬´ì—‡ì¸ì§€ ì•Œì•„ì•¼í•œë‹¤.
    // findById : Idì— ë”°ë¥¸ íŠ¹ì •í•œ ê°’ ì°¾ê¸°
    const currentTodo = await Todo.findById(todoId).exec();
    if (!currentTodo) {
        // ì„ íƒ ì½”ë“œ 404 : í´ë¼ì´ì–¸íŠ¸ê°€ ë°œìƒì‹œí‚¨ ì—ëŸ¬.
        return res
            .status(404)
            .json({ errorMessage: "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” todo ë°ì´í„°ì…ë‹ˆë‹¤." });
    }

    // ì‹¤ì œë¡œ í•´ì•¼í•  ì¼ì˜ ìˆœì„œ ë³€ê²½
    // 1. orderë¼ê³  í•˜ëŠ” ë°ì´í„°ê°€ ì¡°íšŒë˜ì—ˆëŠ”ì§€ í™•ì¸ : orderë¼ëŠ” ê°’ì´ ìˆì„ ë•Œë§Œ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ìˆ˜í–‰.
    // ex. 3ë²ˆì„ 2ë²ˆìœ¼ë¡œ ë³€ê²½í•˜ë ¤ê³  í•  ë•Œ, 2ë²ˆ ë°ì´í„°ê°€ í˜„ì¬ ì¡´ì¬í•˜ê³  ìˆëŠ”ê°€? ì— ëŒ€í•œ ì¡°ê±´ ê²€ì‚¬
    if (order) {
        // 3ë²ˆ(currentTodo)ì„ 2ë²ˆ(targetTodo)ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ê³  í•  ë•Œ, order 2ë²ˆ ì¡°íšŒ.
        // find() : ëª©ë¡ ì¡°íšŒ, findOne() : ëª©ë¡ ì¤‘ í•˜ë‚˜ë§Œ ì¡°íšŒ.
        // ê°ì²´ êµ¬ì¡° ë¶„í•´ í• ë‹¹ìœ¼ë¡œ ì¸í•´ì„œ ({order}) ë§Œ ì‚¬ìš© ê°€ëŠ¥
        // const targetTodo = await Todo.findOne({ order: order }).exec();
        const targetTodo = await Todo.findOne({ order }).exec();
        // 3ë²ˆì„ 2ë²ˆìœ¼ë¡œ ë³€ê²½í•˜ë ¤ê³  í•  ë•Œ, order 2ë²ˆ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´???
        // í˜„ì¬ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°ì´í„°(3ë²ˆ)ì„ ë³€ê²½í•  í•„ìš”ê°€ ì—†ì–´ì§„ë‹¤. (ì–´ì°¨í”¼ 2ë²ˆìœ¼ë¡œ ë•¡ê²¨ì§€ë‹ˆê¹Œ?)
        //	===> ë”°ë¼ì„œ, targetTodo(2ë²ˆ)ì´ ì¡´ì¬í–ˆì„ ë•Œë§Œ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ ì¡°ê±´ì„ í•œ ë²ˆ ë” ê±´ë‹¤.
        if (targetTodo) {
            // ë°ì´í„° ìˆœì„œë¥¼ ë°”ê¾¼ë‹¤.
            // í•´ì•¼í•  ì¼ì˜ ìˆœì„œë¥¼ ë‚´ê°€ ê°€ì§€ê³  ìˆëŠ” ê°’ì˜ orderê°’ìœ¼ë¡œ ë³€ê²½í•œë‹¤.
            targetTodo.order = currentTodo.order;
            await targetTodo.save();
        }

        // í˜„ì¬ ê°’ì˜ order ë˜í•œ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ë˜‘ê°™ì´ ë³€ê²½í•œ order ê°’ìœ¼ë¡œ ë³€ê²½.
        // ë³€ê²½í•˜ë ¤ëŠ” 'í•´ì•¼í•  ì¼'ì˜ order ê°’ì„ ë³€ê²½í•©ë‹ˆë‹ˆë‹¤.
        currentTodo.order = order;
    }

    //----------------------------------------------------------------------------
    /** * í•´ì•„í•  ì¼ ìˆœì„œ ë³€ê²½, ì™„ë£Œ / í•´ì œ API * **/
    // doneì˜ ê°’ì„ ì „ë‹¬ ë°›ì•˜ì§€ë§Œ, doneì´ nullì´ë‚˜ trueì¼ë•Œë§Œ ì¡°ê±´ë¬¸ ì‹¤í–‰
    // doneì˜ ê°’ë§Œ ìˆê²Œ ë˜ë©´ trueê°€ ìˆì„ ë•Œ ë“¤ì–´ì˜¤ì§€ë§Œ,
    // í•´ì•¼í•  ì¼ì„ í•´ì œí•  ë•Œ ì¦‰, false ê°’ì„ ì¤„ ë•ŒëŠ” ì¡°ê±´ë¬¸ì„ ì‹¤í–‰í•˜ì§€ ì•Šê²Œëœë‹¤ëŠ” ì˜¤ë¥˜ê°€ ìˆë‹¤.
    // ===> ê·¸ë˜ì„œ undefinedê°€ ì•„ë‹ ë•Œë§Œ ì¡°ê±´ë¬¸ ì‹¤í–‰.
    if (done !== undefined) {
        // done ê°’ì´ ì¡´ì¬í–ˆì„ ë•ŒëŠ” í˜„ì¬ ì‹œê°„ ë„£ì–´ì£¼ê³ , ì¡´ì¬í•˜ì§€ ì•Šì•˜ì„ ë•ŒëŠ” null ë„£ì–´ì¤€ë‹¤.
        currentTodo.doneAt = done ? new Date() : null;
        console.log("Done value:", done);
    }
    //----------------------------------------------------------------------------
    /** * í•´ì•„í•  ì¼ ë‚´ìš© ë³€ê²½ API * **/
    if (value) {
        currentTodo.value = value;
    }

    // ìµœì¢…ì ìœ¼ë¡œ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•œë‹¤.
    // ë‚´ê°€ ì „ë‹¬ë°›ì€ todoIdì— í•´ë‹¹í•˜ëŠ” í•´ì•¼í•  ì¼ ë˜í•œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•œë‹¤.
    // ë³€ê²½ëœ 'í•´ì•¼í•  ì¼'ì„ ì €ì¥í•©ë‹ˆë‹¤.
    await currentTodo.save();

    return res.status(200).json({});
});

//----------------------------------------------------------------------------
/** * í•  ì¼ ì‚­ì œ API * **/
router.delete("/todos/:todoId", async (req, res, next) => {
    const { todoId } = req.params;

    const todo = await Todo.findById(todoId).exec();
    if (!todo) {
        return res
            .status(404)
            .json({ errorMessage: "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í•´ì•¼í•  ì¼ ì •ë³´ì…ë‹ˆë‹¤." });
    }

    // ê¸°ë³¸í‚¤ë¥¼ ì‚­ì œí•˜ê²Œ ëœë‹¤. -> _id ë¡œ ì‘ì„±í•œë‹¤.
    //  => _id ë¡œ ì‘ì„±í•˜ê²Œ ë˜ë©´ ì–´ë–¤ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ í•´ë‹¹í•˜ëŠ” ë°ì´í„° ì¼ì¹˜í–ˆì„ ë•Œ ì‚­ì œí•  ìˆ˜ ìˆì„ì§€ ì •í•  ìˆ˜ ìˆë‹¤.
    //  ===> ê¸°ë³¸ì ìœ¼ë¡œ mongoDBëŠ” _id ë¼ê³  í•˜ëŠ” ê°’ì´, ë‚´ê°€ ì „ë‹¬ë°›ì€ todoId ì— í•´ë‹¹í•œë‹¤.
    await Todo.deleteOne({ _id: todoId });

    return res.status(200).json({});
});

// ìƒì„±í•œ ë¼ìš°í„°ë¥¼ ì‹¤ì œ ì™¸ë¶€ë¡œ ë³´ë‚´ì¤„ ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ì¤˜ì•¼í•œë‹¤.
// -> todos.router.js ì˜ routerë¥¼ ì™¸ë¶€ë¡œ ë³´ë‚´ì¤„ ìˆ˜ ìˆê²Œ ëœë‹¤.
// => ì™¸ë¶€ë¡œ ë³´ë‚´ì¤€ ë¼ìš°í„°ë¥¼ ì‹¤ì œ ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” expressì— ì ìš©ì‹œì¼œì¤˜ì•¼í•œë‹¤.
// ===> app.js ë¡œ ê°€ì!
export default router;
